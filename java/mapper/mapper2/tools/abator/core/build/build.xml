<project name="Abator for iBATIS" default="buildAbator" basedir=".">

  <!-- 
    This is the build file for Abator.  To run the build,
    execute this command:
    
       ant -lib ../devlib
       
       (This will execute the default build target of buildAbator)
       
       It is required to add the -lib parameter, the tests will not run
       properly without it.
    
    You can also delete the generated artifacts with:
    
       ant clean
    
    Important: the build requires a JSE 5.0 or greater compiler!!!
       Abator itself is compiled for JSE 1.4, but the tests require 5.0.
    
    Note: to update the version of Abator, change the 
       version.properties file (the "version" property).
  -->
  
  <property name="src.dir" value="${basedir}/../src" />
  <property name="doc.dir" value="${basedir}/../doc" />
  <property name="html.doc.dir" value="${basedir}/../htmldoc" />
  <property name="deploy.dir" value="${basedir}/deploy" />
  <property name="deploy.files" value="${deploy.dir}/files" />
  <property name="work.dir" value="${basedir}/work" />
  <property name="work.classes" value="${work.dir}/bin" />
  <property name="work.javadoc" value="${work.dir}/javadoc" />
  <property name="test.src.dir" value="${work.dir}/test/src" />
  <property name="generated.source.dir" value="${work.dir}/src" />
  <property name="reports.dir" value="${basedir}/reports" />
  <property name="reports.junit" value="${reports.dir}/junit" />
  
  <target name="clean" unless="${TSTAMP}">
  	<tstamp/>
    <delete dir="${work.dir}" />
    <delete dir="${deploy.dir}" />
    <delete dir="${reports.dir}" />
  </target>
  
  <target name="build.prepare" depends="clean">
    <mkdir dir="${deploy.dir}"/>
    <mkdir dir="${work.dir}"/>
    <mkdir dir="${work.classes}"/>

    <copy todir="${deploy.files}">
      <fileset dir="${doc.dir}">
        <exclude name="**/.svn/**"/>
      </fileset>
    </copy>
    
    <copy todir="${deploy.files}/doc">
      <fileset dir="${html.doc.dir}">
        <exclude name="**/.svn/**"/>
      </fileset>
    </copy>
  	
    <propertyfile file="version.properties" comment="Abator build version info">
      <entry key="buildNum" default="0" type="int" operation="+" value="1"/>
    </propertyfile>
  </target>
  
  <target name="build.compile" depends="build.prepare">
    <javac srcdir="${src.dir}"
    	destdir="${work.classes}"
    	deprecation="true" 
    	debug="true" 
    	source="1.4"
    	target="1.4"
        classpath="../devlib/ant.jar"/>
  </target>
	  	
  <target name="build.abator.jar" depends="build.compile">

    <!-- copy non-compilable resources -->    
    <copy todir="${work.classes}">
      <fileset dir="${src.dir}" >
        <exclude name="**/*.java"/>
        <exclude name="**/.*/**"/>  <!-- exclude any . files (SVN) -->
      </fileset>
    </copy>
    
    <property file="version.properties"/>
    
    <jar destfile="${deploy.files}/abator.jar" basedir="${work.classes}" >
      <manifest>
        <attribute name="Main-Class" value="org.apache.ibatis.abator.api.AbatorRunner"/>
        <attribute name="Specification-Title" value="Abator for iBATIS"/>
        <attribute name="Specification-Version" value="${version}"/>
        <attribute name="Specification-Vendor" value="The Apache Software Foundation"/>
      </manifest>
    </jar>
  </target>
  
  <target name="build.abator.javadoc">
    <javadoc destdir="${work.javadoc}" use="true" defaultexcludes="false" verbose="false">
      <packageset dir="${src.dir}">
        <include name="org/apache/ibatis/abator/**"/>
      </packageset>
    </javadoc>
    
    <zip destfile="${deploy.files}/abator-javadoc.zip" basedir="${work.javadoc}" />
  </target>
  
  <target name="build.zip.abator.source">
    <zip destfile="${deploy.files}/abator-src.zip" basedir="${src.dir}" />
  </target>
  
  <target name="assemble.zipfile" depends="build.abator.jar, build.abator.javadoc, build.zip.abator.source">
    <property file="version.properties"/>
    
    <zip destfile="${deploy.dir}/abator-${version}-${buildNum}.zip" basedir="${deploy.files}" />
  </target>
  
  <target name="buildAbator" depends="assemble.zipfile, test.report" >
    <fail if="testsFailed" message="The tests did not pass"/>
  </target>
  
  <target name="test.prepare" depends="build.compile">
    <mkdir dir="${generated.source.dir}"/>
    <mkdir dir="${reports.dir}"/>
    <mkdir dir="${reports.junit}"/>
	  	
  	<copy todir="${generated.source.dir}">
  		<fileset dir="${basedir}/../test" />
  	</copy>
  </target>
	  
  <target name="test.generate.test.code" depends="test.prepare">
  	<!-- note that the class does not exist until the build runs.
  	 Validating Ant editors will complain that the task cannot be
  	 found, but it's not really an error. -->
  	<taskdef name="abator"
  	         classname="org.apache.ibatis.abator.ant.AbatorAntTask">
  		<classpath>
  			<pathelement location="${work.classes}"/>
  		</classpath>
  	</taskdef>
	  	
  	<!-- create the test database -->
  	<sql driver="org.hsqldb.jdbcDriver"
  		url="jdbc:hsqldb:mem:aname"
  		userid="sa"
  		password=""
  		src="${generated.source.dir}/abatortest/CreateDB.sql"/>
	  	
  	<abator configfile="${generated.source.dir}/abatortest/abatorConfig.xml" >
  		<propertyset>
  			<propertyref name="generated.source.dir"/>
  		</propertyset>
  	</abator>
  </target>
	  	
  <target name="test.compile.test.code" depends="test.generate.test.code">
    <javac srcdir="${generated.source.dir}"
    	deprecation="true" 
    	debug="true"
    	source="1.5"
    	target="1.5">
    </javac>
  </target>
		
  <target name="test.run" depends="test.compile.test.code">
    <junit printsummary="true" showoutput="true">
      <formatter type="xml"/>
      <batchtest todir="${reports.junit}" fork="yes" haltonerror="no" failureproperty="testsFailed">
        <fileset dir="${generated.source.dir}">
          <exclude name="**/AllExecuteTests.class"/>
          <include name="**/*Tests.class"/>
        </fileset>
      </batchtest>
      <classpath>
      	<pathelement location="${generated.source.dir}"/>
		<pathelement location="${basedir}/../devlib/ibatis-common-2.jar" />
		<pathelement location="${basedir}/../devlib/ibatis-dao-2.jar" />
		<pathelement location="${basedir}/../devlib/ibatis-sqlmap-2.jar" />
		<pathelement location="${basedir}/../devlib/hsqldb.jar" />
      </classpath>
    </junit>
  </target>
	  
  <target name="test.report" depends="test.run" >
    <junitreport todir="${reports.junit}">
      <fileset dir="${reports.junit}">
        <include name="TEST-*.xml"/>
      </fileset>
	      <report format="frames" todir="${reports.junit}"/>
    </junitreport>
  </target>

</project>