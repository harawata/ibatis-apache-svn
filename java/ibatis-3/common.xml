<project name="Maven Module Builder" default="all" basedir="." xmlns:artifact="urn:maven-artifact-ant">

  <!-- INPUTS -->
  <!-- <property name="module" value="some-module-name" /> -->
  <property name="src.dir" value="${module}/src/main/java" />
  <property name="test.dir" value="${module}/src/test/java" />

  <!-- OUTPUTS -->
  <property name="build.root" value="./build/${module}"/>

  <property name="classes" value="${build.root}/classes"/>
  <property name="classes.test" value="${build.root}/classes-test"/>
  <property name="classes.instrumented" value="${build.root}/classes-instrumented"/>

  <property name="reports.junit" value="${build.root}/reports-junit"/>
  <property name="reports.coverage" value="${build.root}/reports-coverage"/>

  <property name="deploy.exploded" value="${build.root}/exploded"/>
  <property name="deploy.dist" value="${build.root}/dist"/>

  <!-- MAVEN -->

  <path id="maven-ant-tasks.classpath"
        path="ant-lib/maven-ant-tasks-2.0.9.jar" />

  <typedef resource="org/apache/maven/artifact/ant/antlib.xml"
           uri="urn:maven-artifact-ant"
           classpathref="maven-ant-tasks.classpath" />

  <artifact:pom id="${module}.pom" file="${module}/pom.xml" />

  <artifact:dependencies pathId="compile.dep" usescope="compile" pomrefid="${module}.pom" />
  <artifact:dependencies pathId="test.dep" usescope="test" pomrefid="${module}.pom" />

  <!-- EMMA -->

  <path id="emma.classpath">
    <pathelement  location="ant-lib/emma_ant.jar" />
    <pathelement  location="ant-lib/emma.jar" />
  </path>

  <taskdef resource="emma_ant.properties"
           classpathref="emma.classpath" />

  <!-- PATHS -->

  <path id="classes-to-instrument">
    <pathelement location="${classes}"/>
  </path>

  <path id="classpath">
    <pathelement location="${classes}"/>
    <pathelement location="${classes.test}"/>
    <path refid="emma.classpath"/>
    <path refid="compile.dep"/>
    <path refid="test.dep"/>
  </path>

  <target name="clean">
    <delete dir="${build.root}"/>
    <delete dir="ibderby"/>
    <delete dir="${module}/ibderby"/>
    <delete>
      <fileset dir="./">
        <include name="junit*.properties"/>
        <include name="coverage.ec"/>
        <include name="derby.log"/>
        <include name="${module}/derby.log"/>
      </fileset>
    </delete>
  </target>

  <target name="prepare" depends="clean">
    <mkdir dir="${build.root}"/>
    <mkdir dir="${classes}"/>
    <mkdir dir="${classes.test}"/>
    <mkdir dir="${classes.instrumented}"/>
    <mkdir dir="${reports.junit}"/>
    <mkdir dir="${reports.coverage}"/>
    <mkdir dir="${deploy.exploded}"/>
    <mkdir dir="${deploy.dist}"/>
    <!-- Prepare Release Docs -->
    <propertyfile file="version.properties" comment="Build version info">
      <entry key="buildDate" type="date" value="now"/>
      <entry key="buildNum" default="0" type="int" operation="+" value="1"/>
    </propertyfile>
  </target>

  <target name="compile" depends="prepare">
    <javac srcdir="${src.dir}" destdir="${classes}" classpathref="classpath" deprecation="false" debug="true"/>
    <copy todir="${classes}">
      <fileset dir="${src.dir}" >
        <exclude name="**/*.java"/>
      </fileset>
    </copy>
    <javac srcdir="${test.dir}" destdir="${classes.test}" classpathref="classpath" deprecation="false" debug="true"/>
    <copy todir="${classes.test}">
      <fileset dir="${test.dir}" >
        <exclude name="**/*.java"/>
      </fileset>
    </copy>
  </target>

  <target name="test.instrument" depends="compile">
    <emma>
      <instr instrpathref="classes-to-instrument"
        destdir="${classes.instrumented}"
        metadatafile="./coverage.ec"
        merge="true">
        <filter excludes="org.apache.ibatis.ognl.*"/>
      </instr>
    </emma>
  </target>

  <target name="test.run" depends="test.instrument">
    <junit printsummary="true" showoutput="true">
      <formatter type="xml"/>
      <batchtest todir="${reports.junit}" fork="yes" haltonerror="no" failureproperty="testsFailed">
        <fileset dir="${classes.test}">
          <include name="**/*Test.class"/>
          <exclude name="**/Base*Test.class"/>
        </fileset>
      </batchtest>
      <classpath path="${classes.instrumented}"/>
      <classpath refid="classpath"/>
    </junit>
  </target>

  <target name="test.report" depends="test.run" >
    <junitreport todir="${reports.junit}">
      <fileset dir="${reports.junit}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="${reports.junit}"/>
    </junitreport>
  </target>

  <target name="test.coverage" depends="test.report" >
    <emma>
      <report sourcepath="${src.dir}"
        sort="+block,+name,+method,+class"
        metrics="method:70,block:80,line:80,class:100"
        >
        <fileset dir="./">
          <include name="*.ec"/>
        </fileset>
        <html outfile="${reports.coverage}/coverage.html"
          depth="method"
          columns="name,class,method,block,line"
          />
      </report>
    </emma>
  </target>

  <target name="dist.jar.lib" depends="compile">
    <property file="version.properties"/>
    <jar jarfile="${deploy.exploded}/${module}-${version}.${buildNum}.jar">
      <manifest>
        <attribute name="Built-On" value="${buildDate}"/>
	      <section name="${module}">
          <attribute name="Implementation-Title" value="${module}"/>
          <attribute name="Implementation-Version" value="${version} build# ${buildNum}"/>
          <attribute name="Implementation-Vendor" value="Apache Software Foundation"/>
        </section>
      </manifest>
      <fileset dir="${classes}"/>
      <fileset dir="./">
        <include name="LICENSE"/>
        <include name="NOTICE"/>
      </fileset>
    </jar>
  </target>

  <target name="dist.jar.src" depends="compile">
    <property file="version.properties"/>
    <jar jarfile="${deploy.exploded}/${module}-src-${version}.${buildNum}.zip">
      <manifest>
        <attribute name="Built-On" value="${buildDate}"/>
	      <section name="${module}">
          <attribute name="Implementation-Title" value="${module}"/>
          <attribute name="Implementation-Version" value="${version} build# ${buildNum}"/>
          <attribute name="Implementation-Vendor" value="Apache Software Foundation"/>
        </section>
      </manifest>
      <fileset dir="${src.dir}"/>
      <fileset dir="./">
        <include name="LICENSE"/>
        <include name="NOTICE"/>
      </fileset>
    </jar>
  </target>

  <target name="dist.assemble" depends="dist.jar.lib,dist.jar.src">
    <copy todir="${deploy.exploded}">
      <fileset dir="./">
        <include name="LICENSE"/>
        <include name="NOTICE"/>
      </fileset>
    </copy>
  </target>

  <target name="dist" depends="dist.assemble">
    <property file="version.properties"/>
    <jar jarfile="${deploy.dist}/${module}-${version}.${buildNum}.zip">
      <fileset dir="${deploy.exploded}"/>
    </jar>
  </target>

  <target name="all" depends="test.coverage,dist">
    <fail if="testsFailed" message="The tests did not pass"/>
  </target>

</project>
